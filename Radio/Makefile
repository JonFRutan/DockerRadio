#jfr
PLAYLIST_DIR = Playlists
CONFIG_FILE = radio.liq
ICECAST_PASS = 499493
ENV_FILE = .env

#see what OS is being run on
ifeq ($(OS),Windows_NT)
DETECTED_OS := Windows
OPEN_CMD := start
else
DETECTED_OS := $(shell uname -s)
ARCH := $(shell uname -m)
ifeq ($(DETECTED_OS),Darwin)
OPEN_CMD := open
else
OPEN_CMD := xdg-open
endif
endif

#if someones on mac, use arm configs
ifeq ($(ARCH),arm64)
ICE_IMG := infiniteproject/icecast:alpine
LIQ_IMG := savonet/liquidsoap:v2.2.5
PLATFORM_MSG := "ARM64 Setup"
else
#otherwise use amd64
ICE_IMG := libretime/icecast:latest
LIQ_IMG := savonet/liquidsoap:v2.3.0
PLATFORM_MSG := "AMD64 Setup"
endif

.PHONY: all help init station up down clean

help:
	@echo "  LUG DOCKER WORKSHOP - COMMANDS "
	@echo "  make init    - Generates a config based on your device"
	@echo "  make station - Create a new radio station"
	@echo "  make up      - Start the Docker containers"
	@echo "  make down    - Stop the Docker containers"
	@echo "  make clean   - Remove all stations and configs"
	@echo "  -----------------------------------------------"
	@echo "  MAKE SURE YOU HAVE DOCKER INSTALLED!"
	@echo "  COMMANDS SHOULD BE RUN AS SUDO/ADMIN!"

init:
	@mkdir -p $(PLAYLIST_DIR)
	@echo "# Auto-generated by Makefile" > $(ENV_FILE)
	@echo "ICECAST_IMAGE=$(ICE_IMG)" >> $(ENV_FILE)
	@echo "LIQUIDSOAP_IMAGE=$(LIQ_IMG)" >> $(ENV_FILE)
	@echo $(PLATFORM_MSG)
	@echo "Environment configured in $(ENV_FILE)"
	
	@if [ ! -f $(CONFIG_FILE) ]; then \
		echo 'settings.harbor.bind_addrs.set(["0.0.0.0"])' > $(CONFIG_FILE); \
		echo 'print("Radio System Online...")' >> $(CONFIG_FILE); \
	fi

station: init
	@echo "Creating a new station..."
	@read -p "Enter Station Name (no spaces, e.g., Classical): " name; \
	if [ -z "$$name" ]; then echo "Name cannot be empty"; exit 1; fi; \
	mkdir -p $(PLAYLIST_DIR)/$$name; \
	echo "" >> $(CONFIG_FILE); \
	echo "# Station: $$name" >> $(CONFIG_FILE); \
	echo "$$name = playlist(reload_mode=\"watch\", \"/music/$$name\")" >> $(CONFIG_FILE); \
	echo "$$name = mksafe($$name)" >> $(CONFIG_FILE); \
	echo "output.icecast(%mp3, host=\"icecast\", port=8000, password=\"$(ICECAST_PASS)\", mount=\"/$$name\", name=\"$$name-FM\", $$name)" >> $(CONFIG_FILE); \
	echo "Station '$$name' created."; \
	echo "		1. Put your MP3s in: $(PLAYLIST_DIR)/$$name"; \
	echo "		2. Run 'make up' to start broadcasting."

up: init
	docker compose up -d
	@echo "Waiting for services..."
	@sleep 5

down:
	docker compose down

clean:
	docker compose down
	rm -f $(CONFIG_FILE) $(ENV_FILE)
	@echo "    Config cleaned. Playlist MP3s were kept safe."